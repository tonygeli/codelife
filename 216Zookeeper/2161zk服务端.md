# Watch机制的实现原理

先进先出FIFO



#### 服务端触发过程：

- 调用WatchManager中的方法触发数据变更事件
- 封装了一个具有会话状态、事件类型、数据节点3种属性的WatchedEvent对象，之后查询该节点注册的Watch事件，如果为空说明该节点没有注册过Watch事件。如果存在Watch事件则添加到定义的Watchers集合中，并在WatchManager管理中删除。最后，通过调用process方法向客户端发送通知。

#### 客户端回调过程：

- 使用SendThread.readResponse()方法来统一出来服务端





## ZK分布式锁实现原理



- 上来直接创建一个锁节点下的一个接一个的临时顺序节点
- 如果自己不是第一个节点，就对自己上一个节点加监听器
- 只要上一个节点释放锁，自己就排到前面去了，相当于是一个排队机制。

而且用临时顺序节点，如果某个客户端创建临时顺序节点之后，自己宕机了，zk感知到那个客户端宕机，会自动删除对应的临时顺序节点，相当于自动释放锁，或者是自动取消自己的排队。解决了惊群效应。



## zk的经典应用场景

通过对Zookeeper中丰富的数据节点进行交叉使用，配合Watcher时间通知机制



























