[TOC]



**前言**

自从有了 SpringBoot 之后，咋们就起飞了！各种零配置开箱即用，而我们之所以开发起来能够这么爽，**自动配置**的功劳少不了，今天我们就一起来讨论一下 SpringBoot 自动配置原理。

本文主要分为三大部分：

1. SpringBoot 源码常用注解拾遗
2. SpringBoot 启动过程
3. SpringBoot 自动配置原理



## 一. SpringBoot 源码常用注解拾遗

这部分主要讲一下 SpringBoot 源码中经常使用到的注解，以扫清后面阅读源码时候的障碍。

### 组合注解

> 当可能大量同时使用到几个注解到同一个类上，就可以考虑将这几个注解到别的注解上。被注解的注解我们就称之为组合注解。

- 元注解：可以注解到别的注解上的注解。
- 组合注解：被注解的注解我们就称之为组合注解。

### @Value 【Spring 提供】

> `@Value` 就相当于传统 xml 配置文件中的 value 字段。

假设存在代码：

```java
@Component 
public class Person { 
  
  @Value("i am name") 
  private String name; 
} 
```

上面代码等价于的配置文件：

```java
<bean class="Person"> 
	<property name ="name" value="i am name"></property>
</bean> 
```

我们知道配置文件中的 value 的取值可以是：

- 字面量
- 通过 `${key}` 方式从环境变量中获取值
- 通过 `${key}` 方式全局配置文件中获取值
- `#{SpEL}`

> 所以，我们就可以通过 `@Value(${key})` 的方式获取全局配置文件中的指定配置项。

### @ConfigurationProperties 【SpringBoot 提供】

如果我们需要取 N 个配置项，通过 @Value 的方式去配置项需要一个一个去取，这就显得有点 low 了。我们可以使用 `@ConfigurationProperties` 。

> 标有 `@ConfigurationProperties` 的类的所有属性和配置文件中相关的配置项进行绑定。（默认从全局配置文件中获取配置值），绑定之后我们就可以通过这个类去访问全局配置文件中的属性值了。

下面看一个实例：

\1. 在主配置文件中添加如下配置

```java
person.name=kundy 
person.age=13 
person.sex=male 
```

\2. 创建配置类，由于篇幅问题这里省略了 setter、getter 方法，但是实际开发中这个是必须的，否则无法成功注入。另外，@Component 这个注解也还是需要添加的。

```java
@Component 
@ConfigurationProperties(prefix = "person") 
public class Person { 

  private String name; 
  private Integer age; 
  private String sex; 
} 
```

> 这里 @ConfigurationProperties 有一个 `prefix` 参数，主要是用来指定该配置项在配置文件中的前缀。

\3. 测试，在 SpringBoot 环境中，编写个测试方法，注入 Person 类，即可通过 Person 对象取到配置文件的值。

### @Import 【Spring 提供】

> `@Import` 注解支持导入普通 java 类，并将其声明成一个bean。主要用于将多个分散的 java config 配置类融合成一个更大的 config 类。

- `@Import` 注解在 4.2 之前只支持导入配置类。
- 在4.2之后 `@Import` 注解支持导入普通的 java 类,并将其声明成一个 bean。

**@Import 三种使用方式 **

- 直接导入普通的 Java 类。
- 配合自定义的 ImportSelector 使用。
- 配合 ImportBeanDefinitionRegistrar 使用。

**1. 直接导入普通的 Java 类**

\1. 创建一个普通的 Java 类。

```java
public class Circle { 

public void sayHi() { 
System.out.println("Circle sayHi()"); 
} 

} 
```

\2. 创建一个配置类，里面没有显式声明任何的 Bean，然后将刚才创建的 Circle 导入。

```java
@Import({Circle.class}) 
@Configuration 
public class MainConfig { 

} 
```

\3. 创建测试类。

```java
public static void main(String[] args) { 
  ApplicationContext context = new AnnotationConfigApplicationContext(MainConfig.class); 
  Circle circle = context.getBean(Circle.class); 
  circle.sayHi(); 
} 
```

\4. 运行结果：

> Circle sayHi()

可以看到我们顺利的从 IOC 容器中获取到了 Circle 对象，证明我们在配置类中导入的 Circle 类，确实被声明为了一个 Bean。



**2. 配合自定义的 ImportSelector 使用**

> `ImportSelector` 是一个接口，该接口中只有一个 selectImports 方法，用于返回全类名数组。所以利用该特性我们可以给容器**动态导入 N 个** Bean。

\1. 创建普通 Java 类 Triangle。

```java
public class Triangle { 

public void sayHi(){ 
System.out.println("Triangle sayHi()"); 
} 

}
```

\2. 创建 ImportSelector 实现类，selectImports 返回 Triangle 的全类名。

```java
public class MyImportSelector implements ImportSelector { 

@Override 
public String[] selectImports(AnnotationMetadata annotationMetadata) { 
return new String[]{"annotation.importannotation.waytwo.Triangle"}; 
} 

} 
```

\3. 创建配置类，在原来的基础上还导入了 MyImportSelector。

```java
@Import({Circle.class,MyImportSelector.class}) 
@Configuration 
public class MainConfigTwo { 

} 
```

\4. 创建测试类

```java
public static void main(String[] args) { 

ApplicationContext context = new AnnotationConfigApplicationContext(MainConfigTwo.class); 
Circle circle = context.getBean(Circle.class); 
Triangle triangle = context.getBean(Triangle.class); 
circle.sayHi(); 
triangle.sayHi(); 

} 
```

\5. 运行结果：

> Circle sayHi()
> Triangle sayHi()

可以看到 Triangle 对象也被 IOC 容器成功的实例化出来了。

**3. 配合 ImportBeanDefinitionRegistrar 使用**

> `ImportBeanDefinitionRegistrar` 也是一个接口，它可以**手动注册bean到容器中**，从而我们可以对类进行个性化的定制。(需要搭配 @Import 与 @Configuration 一起使用。）

\1. 创建普通 Java 类 Rectangle。

```java
public class Rectangle { 
  public void sayHi() { 
  	System.out.println("Rectangle sayHi()"); 
  } 
}
```

\2. 创建 ImportBeanDefinitionRegistrar 实现类，实现方法直接手动注册一个名叫 rectangle 的 Bean 到 IOC 容器中。

```java
public class MyImportBeanDefinitionRegistrar implements ImportBeanDefinitionRegistrar { 

@Override 
public void registerBeanDefinitions(AnnotationMetadata annotationMetadata, BeanDefinitionRegistry beanDefinitionRegistry) { 

RootBeanDefinition rootBeanDefinition = new RootBeanDefinition(Rectangle.class); 
// 注册一个名字叫做 rectangle 的 bean 
beanDefinitionRegistry.registerBeanDefinition("rectangle", rootBeanDefinition); 
} 

} 
```

\3. 创建配置类，导入 MyImportBeanDefinitionRegistrar 类。

```java
@Import({Circle.class, MyImportSelector.class, MyImportBeanDefinitionRegistrar.class}) 
@Configuration 
public class MainConfigThree { 

} 
```

\4. 创建测试类。